<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Commander S.A.M.</title>

  <!-- Bootstrap Core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="css/simple-sidebar.css" rel="stylesheet">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Fontawesome CSS -->
  <script src="https://use.fontawesome.com/469c8a0402.js"></script>

  <!-- Source Sans Pro Font -->
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,700' rel='stylesheet' type='text/css'>


</head>

<body>

  <div id="wrapper">

    <!-- Sidebar -->
    <div id="sidebar-wrapper">
      <ul class="sidebar-nav">
        <li class="sidebar-brand">
          <a href="#">COMMANDER SAM</a>
        </li>
        <li>
          <a href="#">Alerts</a>
        </li>
        <li>
          <a href="#">News feed</a>
        </li>
        <li>
          <a href="#">Settings</a>
        </li>
        <hr>
        <li>
          <a href="#">Traffic</a>
        </li>
        <li>
          <a href="#">Weather</a>
        </li>
        <li>
          <a href="#">Flickr</a>
        </li>
        <li>
          <a href="#">Twitter</a>
        </li>

      </ul>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->



    <div id="page-content-wrapper">
      <div id="map-container"></div>
      <div class="contianer-fluid">

      </div>
    </div>

    <!-- <a href="#menu-toggle" class="btn btn-default" id="menu-toggle"> -->


  </div><!-- /#wrapper -->



  <!-- jQuery -->
  <script src="js/jquery.js"></script>

  <!-- Bootstrap Core JavaScript -->
  <script src="js/bootstrap.min.js"></script>

  <!-- Menu Toggle Script -->
  <script>
  $("#menu-toggle").click(function(e) {
    e.preventDefault();
    $("#wrapper").toggleClass("toggled");
  });
  </script>

  <script>
  var map;
  var geoJSON;
  var request;
  var gettingData = false;
  var openWeatherMapKey = "8032d2849a58979469990327ea564ffa"

  // Clear data layer and geoJSON
  var resetData = function () {
    geoJSON = {
      type: "FeatureCollection",
      features: []
    };
    map.data.forEach(function(feature) {
      map.data.remove(feature);
    });
  };

  function initialize() {
    map = new google.maps.Map(document.getElementById('map-container'), {
      zoom: 4,
      center: {lat: 40.7590113, lng: -73.9861624}
    });

    // Add interaction listeners to make weather requests
    google.maps.event.addListener(map, 'idle', checkIfDataRequested);

    // Sets up and populates the info window with details
    map.data.addListener('click', function(event) {
      infowindow.setContent(
        "<img src=" + event.feature.getProperty("icon") + ">"
        + "<br /><strong>" + event.feature.getProperty("city") + "</strong>"
        + "<br />" + event.feature.getProperty("temperature") + "&deg;C"
        + "<br />" + event.feature.getProperty("weather")
      );
      infowindow.setOptions({
        position:{
          lat: event.latLng.lat(),
          lng: event.latLng.lng()
        },
        pixelOffset: {
          width: 0,
          height: -15
        }
      });
      infowindow.open(map);
    });
  }

  var checkIfDataRequested = function() {
    // Stop extra requests being sent
    while (gettingData === true) {
      request.abort();
      gettingData = false;
    }
    getCoords();
  };

  // Get the coordinates from the Map bounds
  var getCoords = function() {
    var bounds = map.getBounds();
    var NE = bounds.getNorthEast();
    var SW = bounds.getSouthWest();
    getWeather(NE.lat(), NE.lng(), SW.lat(), SW.lng());
  };

  // Make the weather request
  var getWeather = function(northLat, eastLng, southLat, westLng) {
    gettingData = true;
    var requestString = "http://api.openweathermap.org/data/2.5/box/city?bbox="
    + westLng + "," + northLat + "," //left top
    + eastLng + "," + southLat + "," //right bottom
    + map.getZoom()
    + "&cluster=yes&format=json"
    + "&APPID=" + "551b97ca557560dfc7d8c49a81b37d89";
    request = new XMLHttpRequest();
    request.onload = proccessResults;
    request.open("get", requestString, true);
    request.send();
  };

  // For each result that comes back, convert the data to geoJSON
  var jsonToGeoJson = function (weatherItem) {
    var feature = {
      type: "Feature",
      properties: {
        city: weatherItem.name,
        weather: weatherItem.weather[0].main,
        temperature: weatherItem.main.temp,
        min: weatherItem.main.temp_min,
        max: weatherItem.main.temp_max,
        humidity: weatherItem.main.humidity,
        pressure: weatherItem.main.pressure,
        windSpeed: weatherItem.wind.speed,
        windDegrees: weatherItem.wind.deg,
        windGust: weatherItem.wind.gust,
        icon: "http://openweathermap.org/img/w/"
        + weatherItem.weather[0].icon  + ".png",
        coordinates: [weatherItem.coord.lon, weatherItem.coord.lat]
      },
      geometry: {
        type: "Point",
        coordinates: [weatherItem.coord.lon, weatherItem.coord.lat]
      }
    };
    // Set the custom marker icon
    map.data.setStyle(function(feature) {
      return {
        icon: {
          url: feature.getProperty('icon'),
          anchor: new google.maps.Point(25, 25)
        }
      };
    });

    // returns object
    return feature;
  };

  // Add the markers to the map
  var drawIcons = function (weather) {
    map.data.addGeoJson(geoJSON);
    // Set the flag to finished
    gettingData = false;
  };

  // Take the JSON results and proccess them
  var proccessResults = function() {
    console.log(this);
    var results = JSON.parse(this.responseText);
    if (results.list.length > 0) {
      resetData();
      for (var i = 0; i < results.list.length; i++) {
        geoJSON.features.push(jsonToGeoJson(results.list[i]));
      }
      drawIcons(geoJSON);
    }
  };

  var infowindow = new google.maps.InfoWindow();



  function initMap() {
    var map = new google.maps.Map(document.getElementById('map-container'), {
      center: {lat: -34.397, lng: 150.644},
      zoom: 15,
      mapTypeControl: true,
      mapTypeControlOptions: {
        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
        position: google.maps.ControlPosition.TOP_RIGHT
      },
      zoomControl: true,
      zoomControlOptions: {
        position: google.maps.ControlPosition.TOP_RIGHT
      },
      scaleControl: true,
      streetViewControl: true,
      streetViewControlOptions: {
        position: google.maps.ControlPosition.TOP_RIGHT
      },

    });
    var infoWindow = new google.maps.InfoWindow({map: map});
    // Try HTML5 geolocation.
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        var pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        // whiteHouse coordinates
        var whiteHouse = {
          lat: 38.897627,
          lng: -77.036412
        };
        // centers map at whiteHouse
        map.setCenter(pos);
        var marker_1 = new google.maps.Marker({
          position: whiteHouse,
          map: map
        });
        // opens up modal if whiteHouse marker is clicked
        google.maps.event.addListener(marker_1, 'click', function(){
          $('#myModal').modal('show')
        });
        // initializes and displays traffic layer
        var trafficLayer = new google.maps.TrafficLayer();
        google.maps.event.addDomListener(document.getElementById('trafficToggle'), 'click', toggleTraffic);
        function toggleTraffic(){
          if(trafficLayer.getMap() == null){
            // traffic layer disabled --> lets enable
            trafficLayer.setMap(map);
          } else {
            // otherwise, lets disable
            trafficLayer.setMap(null);
          }
        }
      }, function() {
        handleLocationError(true, infoWindow, map.getCenter());
      });
    } else {
      // Browser doesn't support Geolocation
      handleLocationError(false, infoWindow, map.getCenter());
    }
  }
  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ?
      'Error: The Geolocation service failed.' :
      'Error: Your browser doesn\'t support geolocation.');
    }
    </script>

    <!-- temporary API code below for use at NG's github site -->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5ASfYUTVafNwn_g_3P73DIpO4DzJ1Dgk&callback=initMap">
    </script>

    <!-- OpenWeatherMap Javascript -->
    <script src="/js/plugins/openWeather.js"></script>


  </body>

  </html>
